"use strict";
var _ = require("lodash");
var geo = require("geolib");
var Promise = require("bluebird");
var superagent = require("superagent");
var w = require("./onlyworld.json");
function loadbBigWorldfromremotedb(url) {
    return new Promise(function (resolve, reject) {
        var bigWorld;
        superagent.get(url).end(function (err, res) {
            if (err || !res.ok) {
                reject(err);
            }
            else {
                bigWorld = res.body.continents;
                resolve(bigWorld);
            }
        });
    });
}
function loadcontryremotely(url, countryName) {
    return new Promise(function (resolve, reject) {
        var country;
        superagent.get(url + "/country/" + countryName).end(function (err, res) {
            if (err || !res.ok) {
                reject(err);
            }
            else {
                country = res.body;
                resolve(country);
            }
        });
    });
}
var Localize = (function () {
    function Localize(o) {
        if (!o)
            throw Error("no conf");
        if (o.bigWorld) {
            this.bigWorld = o.bigWorld;
            this.world = w;
        }
        else {
            if (o.state)
                this.state = o.state;
            if (o && o.world) {
                this.world = o.world;
            }
            else {
                this.world = w;
            }
            if (o && o.remote) {
                this.remote = o.remote;
            }
            else if (o && o.worldDB) {
                this.worldDB = o.worldDB;
            }
        }
    }
    Localize.prototype.getCountryFromPosition = function (o) {
        var pos = { latitude: o.latitude, longitude: o.longitude };
        var _this = this;
        var exists = false;
        var c;
        var centers = [];
        _.map(_this.world, function (continent) {
            _.map(continent.subcontinents, function (subcontinent) {
                _.map(subcontinent.countries, function (country) {
                    _.map(country.boundaries, function (area) {
                        if (!c) {
                            if (typeof area[0][0] !== "object") {
                                if (geo.isPointInside(pos, area)) {
                                    exists = true;
                                    c = country;
                                }
                                else {
                                    centers.push({ nation: country.name, distance: geo.getDistance(geo.getCenterOfBounds(area), pos) });
                                }
                            }
                            else {
                                _.map(area, function (a) {
                                    if (geo.isPointInside(pos, a)) {
                                        exists = true;
                                        c = country;
                                    }
                                    else {
                                        centers.push({ nation: country.name, distance: geo.getDistance(geo.getCenterOfBounds(a), pos) });
                                    }
                                });
                            }
                        }
                    });
                });
            });
        });
        if (!exists) {
            var dist_1 = false;
            _.map(centers, function (co) {
                if (!dist_1 || co.distance < dist_1.distance) {
                    dist_1 = co;
                }
            });
            _.map(_this.world, function (continent) {
                _.map(continent.subcontinents, function (subcontinent) {
                    _.map(subcontinent.countries, function (country) {
                        if (dist_1.nation == country.name) {
                            c = country;
                        }
                    });
                });
            });
        }
        return c;
    };
    Localize.prototype.checkifInsideState = function (pos) {
        var _this = this;
        if (!this.state)
            throw Error("no state set");
        var position = this.getPositionFromState(pos, _this.state);
        if (position[0].distance < 20000) {
            return position;
        }
        else {
            return false;
        }
    };
    Localize.prototype.reloadCurrentState = function (pos) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.getStates(pos).then(function (s) {
                _this.localization = pos;
                _this.state = s;
                resolve(_this.getPositionFromState(pos));
            }).catch(function (err) {
                reject(err);
            });
        });
    };
    Localize.prototype.setPosition = function (pos) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (!(pos && pos.latitude && pos.longitude)) {
                reject("No coords provided");
            }
            else {
                if (_this.state) {
                    var checkifInsideState = _this.checkifInsideState(pos);
                    if (checkifInsideState) {
                        _this.localization = pos;
                        resolve(checkifInsideState);
                    }
                    else {
                        _this.reloadCurrentState(pos).then(function (s) {
                            resolve(s);
                        }).catch(function (err) {
                            reject(err);
                        });
                    }
                }
                else {
                    _this.reloadCurrentState(pos).then(function (s) {
                        resolve(s);
                    }).catch(function (err) {
                        reject(err);
                    });
                }
            }
        });
    };
    Localize.prototype.getPositionFromState = function (pos, State) {
        var _this = this;
        var allprovinces = _this.getProvincesFromState(State);
        _.map(allprovinces, function (c) {
            c.distance = geo.getDistance({ latitude: c.latitude, longitude: c.longitude }, pos);
        });
        var reprov = _.take(_.orderBy(allprovinces, ['distance'], ['asc']), 2);
        var provinces = [];
        _.map(reprov, function (c) {
            _.map(_this.getCitiesFromProvinces(c.nativeName, State), function (p) {
                p.distance = geo.getDistance({ latitude: p.latitude, longitude: p.longitude }, pos);
                provinces.push(p);
            });
        });
        var cities = _.take(_.orderBy(provinces, ['distance'], ['asc']), 10);
        return cities;
    };
    Localize.prototype.getLocation = function (o) {
        return true;
    };
    Localize.prototype.getinfo = function (o) {
        return true;
    };
    Localize.prototype.getStateFromCountry = function (pos, country) {
        var state;
        if (country.states.length === 1) {
            state = country.states[0];
        }
        else {
            console.log("todo");
        }
        return state;
    };
    Localize.prototype.getFullCountry = function (countryName) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            var exists = false;
            if (_this.bigWorld) {
                _.map(_this.bigWorld, function (continent) {
                    _.map(continent.subcontinents, function (subcontinent) {
                        _.map(subcontinent.countries, function (c) {
                            if (c.name === countryName) {
                                exists = c;
                            }
                        });
                    });
                });
                if (!exists) {
                    reject("no country");
                }
                else {
                    resolve(exists);
                }
            }
            else if (_this.remote) {
                loadcontryremotely(_this.remote, countryName).then(function (co) {
                    resolve(co);
                }).catch(function (err) {
                    reject(err);
                });
            }
            else if (_this.worldDB) {
                loadbBigWorldfromremotedb(_this.worldDB).then(function (world) {
                    _.map(world, function (continent) {
                        _.map(continent.subcontinents, function (subcontinent) {
                            _.map(subcontinent.countries, function (c) {
                                if (c.name === countryName) {
                                    exists = c;
                                }
                            });
                        });
                    });
                    if (!exists) {
                        reject("no country");
                    }
                    else {
                        resolve(exists);
                    }
                }).catch(function (err) {
                    reject(err);
                });
            }
        });
    };
    Localize.prototype.getStates = function (pos) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            var country = _this.getCountryFromPosition(pos);
            _this.getFullCountry(country.name).then(function (c) {
                resolve(_this.getStateFromCountry(pos, c));
            }).catch(function (err) {
                reject(err);
            });
        });
    };
    Localize.prototype.getProvincesFromState = function (state) {
        var _this = this;
        var State = _this.state;
        if (state)
            State = state;
        var provinces = [];
        _.map(State.regions, function (r) {
            _.map(r.cities, function (c) {
                provinces.push(c);
            });
        });
        return provinces;
    };
    Localize.prototype.getCitiesFromProvinces = function (city, state) {
        var _this = this;
        var State = this.state;
        if (state)
            State = state;
        var provinces = [];
        _.map(State.regions, function (r) {
            _.map(r.provinces, function (p) {
                if (p.main.nativeName === city) {
                    _.map(p.cities, function (c) {
                        provinces.push(c);
                    });
                }
            });
        });
        return provinces;
    };
    return Localize;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = Localize;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxJQUFZLENBQUMsV0FBTSxRQUFRLENBQUMsQ0FBQTtBQUU1QixJQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFFOUIsSUFBWSxPQUFPLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFHcEMsSUFBWSxVQUFVLFdBQU0sWUFBWSxDQUFDLENBQUE7QUEyRnpDLElBQU0sQ0FBQyxHQUFnQixPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUduRCxtQ0FBbUMsR0FBRztJQUNsQyxNQUFNLENBQUMsSUFBSSxPQUFPLENBQWMsVUFBQyxPQUFPLEVBQUUsTUFBTTtRQUU1QyxJQUFJLFFBQXFCLENBQUM7UUFFMUIsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLEVBQUUsR0FBRztZQUN0QyxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFFakIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBRWYsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLFFBQVEsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztnQkFDL0IsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1lBQ3JCLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUMsQ0FBQyxDQUFBO0FBRU4sQ0FBQztBQUVELDRCQUE0QixHQUFXLEVBQUUsV0FBbUI7SUFDeEQsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFXLFVBQUMsT0FBTyxFQUFFLE1BQU07UUFFekMsSUFBSSxPQUFpQixDQUFDO1FBRXRCLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLFdBQVcsR0FBRyxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLEVBQUUsR0FBRztZQUNsRSxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDakIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQ2YsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLE9BQU8sR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUNuQixPQUFPLENBQUMsT0FBTyxDQUFDLENBQUE7WUFDcEIsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQyxDQUFDLENBQUE7QUFDTixDQUFDO0FBS0Q7SUFRSSxrQkFBWSxDQUFxRztRQUM3RyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUFDLE1BQU0sS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRy9CLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2IsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDO1lBQzNCLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBRW5CLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUVKLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7Z0JBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBRWxDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDZixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUE7WUFDeEIsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFBO1lBQ2xCLENBQUM7WUFFRCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ2hCLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtZQUMxQixDQUFDO1lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDeEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFBO1lBQzVCLENBQUM7UUFHTCxDQUFDO0lBRUwsQ0FBQztJQUVELHlDQUFzQixHQUF0QixVQUF1QixDQUFnQjtRQUVuQyxJQUFJLEdBQUcsR0FBa0IsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBRTFFLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLE1BQU0sR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFXLENBQUM7UUFDaEIsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBRWpCLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxVQUFVLFNBQVM7WUFDbEMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsYUFBYSxFQUFFLFVBQVUsWUFBWTtnQkFFakQsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLFVBQVUsT0FBTztvQkFFM0MsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLFVBQVUsSUFBSTt3QkFDcEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUVMLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0NBSWpDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztvQ0FDL0IsTUFBTSxHQUFHLElBQUksQ0FBQztvQ0FDZCxDQUFDLEdBQUcsT0FBTyxDQUFDO2dDQUVoQixDQUFDO2dDQUFDLElBQUksQ0FBQyxDQUFDO29DQUNKLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFBO2dDQUN2RyxDQUFDOzRCQUdMLENBQUM7NEJBQUMsSUFBSSxDQUFDLENBQUM7Z0NBR0osQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDO29DQUVuQixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7d0NBQzVCLE1BQU0sR0FBRyxJQUFJLENBQUM7d0NBQ2QsQ0FBQyxHQUFHLE9BQU8sQ0FBQztvQ0FFaEIsQ0FBQztvQ0FBQyxJQUFJLENBQUMsQ0FBQzt3Q0FDSixPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLEdBQUcsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQTtvQ0FDcEcsQ0FBQztnQ0FFTCxDQUFDLENBQUMsQ0FBQTs0QkFDTixDQUFDO3dCQUNMLENBQUM7b0JBQ0wsQ0FBQyxDQUFDLENBQUE7Z0JBR04sQ0FBQyxDQUFDLENBQUE7WUFFTixDQUFDLENBQUMsQ0FBQTtRQUVOLENBQUMsQ0FBQyxDQUFBO1FBRUYsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1YsSUFBSSxNQUFJLEdBQVEsS0FBSyxDQUFDO1lBQ3RCLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFVBQVUsRUFBRTtnQkFDdkIsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFJLElBQUksRUFBRSxDQUFDLFFBQVEsR0FBRyxNQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztvQkFDdkMsTUFBSSxHQUFHLEVBQUUsQ0FBQTtnQkFDYixDQUFDO1lBRUwsQ0FBQyxDQUFDLENBQUE7WUFFRixDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsVUFBVSxTQUFTO2dCQUNsQyxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsVUFBVSxZQUFZO29CQUNqRCxDQUFDLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsVUFBVSxPQUFPO3dCQUMzQyxFQUFFLENBQUMsQ0FBQyxNQUFJLENBQUMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDOzRCQUM5QixDQUFDLEdBQUcsT0FBTyxDQUFBO3dCQUNmLENBQUM7b0JBQ0wsQ0FBQyxDQUFDLENBQUE7Z0JBQ04sQ0FBQyxDQUFDLENBQUE7WUFDTixDQUFDLENBQUMsQ0FBQTtRQUVOLENBQUM7UUFDRCxNQUFNLENBQUMsQ0FBQyxDQUFBO0lBQ1osQ0FBQztJQUdELHFDQUFrQixHQUFsQixVQUFtQixHQUFrQjtRQUNqQyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDakIsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQUMsTUFBTSxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUM7UUFFN0MsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFM0QsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQy9CLE1BQU0sQ0FBQyxRQUFRLENBQUE7UUFDbkIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osTUFBTSxDQUFDLEtBQUssQ0FBQTtRQUNoQixDQUFDO0lBQ0wsQ0FBQztJQUdELHFDQUFrQixHQUFsQixVQUFtQixHQUFrQjtRQUNqQyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDakIsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFVLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFFeEMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDO2dCQUN4QixLQUFLLENBQUMsWUFBWSxHQUFHLEdBQUcsQ0FBQztnQkFDekIsS0FBSyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7Z0JBQ2hCLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUM3QyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHO2dCQUNULE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQTtRQUlOLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQUVELDhCQUFXLEdBQVgsVUFBWSxHQUFrQjtRQUMxQixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDakIsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFVLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFDeEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzFDLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1lBQ2pDLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFFSixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztvQkFDZCxJQUFNLGtCQUFrQixHQUFHLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQTtvQkFDeEQsRUFBRSxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO3dCQUNyQixLQUFLLENBQUMsWUFBWSxHQUFHLEdBQUcsQ0FBQzt3QkFDekIsT0FBTyxDQUFVLGtCQUFrQixDQUFDLENBQUM7b0JBQ3pDLENBQUM7b0JBQUMsSUFBSSxDQUFDLENBQUM7d0JBQ0osS0FBSyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLENBQUM7NEJBQ2pDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDZixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHOzRCQUNULE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQzt3QkFDaEIsQ0FBQyxDQUFDLENBQUE7b0JBQ04sQ0FBQztnQkFDTCxDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDO3dCQUNqQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2YsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQUMsR0FBRzt3QkFDVCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ2hCLENBQUMsQ0FBQyxDQUFBO2dCQUNOLENBQUM7WUFDTCxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0lBSUQsdUNBQW9CLEdBQXBCLFVBQXFCLEdBQWtCLEVBQUUsS0FBYztRQUNuRCxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7UUFHakIsSUFBSSxZQUFZLEdBQVksS0FBSyxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRS9ELENBQUMsQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLFVBQVUsQ0FBQztZQUMzQixDQUFDLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxXQUFXLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3hGLENBQUMsQ0FBQyxDQUFBO1FBR0YsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUV2RSxJQUFJLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDbkIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFRO1lBRTVCLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLEVBQUUsVUFBVSxDQUFDO2dCQUNoRSxDQUFDLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxXQUFXLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUNwRixTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ3JCLENBQUMsQ0FBQyxDQUFBO1FBRU4sQ0FBQyxDQUFDLENBQUE7UUFHRixJQUFJLE1BQU0sR0FBcUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUd2RixNQUFNLENBQUMsTUFBTSxDQUFBO0lBRWpCLENBQUM7SUFHRCw4QkFBVyxHQUFYLFVBQVksQ0FBbUM7UUFDM0MsTUFBTSxDQUFDLElBQUksQ0FBQTtJQUVmLENBQUM7SUFFRCwwQkFBTyxHQUFQLFVBQVEsQ0FBbUM7UUFDdkMsTUFBTSxDQUFDLElBQUksQ0FBQTtJQUNmLENBQUM7SUFHRCxzQ0FBbUIsR0FBbkIsVUFBb0IsR0FBa0IsRUFBRSxPQUFpQjtRQUVyRCxJQUFJLEtBQWEsQ0FBQztRQUdsQixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlCLEtBQUssR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQzdCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7UUFFdkIsQ0FBQztRQUdELE1BQU0sQ0FBQyxLQUFLLENBQUE7SUFDaEIsQ0FBQztJQUdELGlDQUFjLEdBQWQsVUFBZSxXQUFtQjtRQUM5QixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7UUFFakIsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFXLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFFekMsSUFBSSxNQUFNLEdBQVEsS0FBSyxDQUFDO1lBR3hCLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUNqQixDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsVUFBVSxTQUFTO29CQUVyQyxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsVUFBVSxZQUFZO3dCQUVqRCxDQUFDLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDOzRCQUNyQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUM7Z0NBQ3pCLE1BQU0sR0FBRyxDQUFDLENBQUM7NEJBQ2YsQ0FBQzt3QkFDTCxDQUFDLENBQUMsQ0FBQTtvQkFDTixDQUFDLENBQUMsQ0FBQTtnQkFDTixDQUFDLENBQUMsQ0FBQTtnQkFDRixFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQ1YsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFBO2dCQUN4QixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtnQkFFbkIsQ0FBQztZQUNMLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBRXRCLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsRUFBRTtvQkFDbEQsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFBO2dCQUNmLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFDLEdBQUc7b0JBQ1QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO2dCQUNmLENBQUMsQ0FBQyxDQUFBO1lBRU4sQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDdkIseUJBQXlCLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLEtBQUs7b0JBQ2hELENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLFVBQVUsU0FBUzt3QkFDNUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsYUFBYSxFQUFFLFVBQVUsWUFBWTs0QkFDakQsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQztnQ0FDckMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDO29DQUN6QixNQUFNLEdBQUcsQ0FBQyxDQUFDO2dDQUNmLENBQUM7NEJBQ0wsQ0FBQyxDQUFDLENBQUE7d0JBQ04sQ0FBQyxDQUFDLENBQUE7b0JBQ04sQ0FBQyxDQUFDLENBQUE7b0JBQ0YsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO3dCQUNWLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQTtvQkFDeEIsQ0FBQztvQkFBQyxJQUFJLENBQUMsQ0FBQzt3QkFDSixPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7b0JBRW5CLENBQUM7Z0JBRUwsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQUMsR0FBRztvQkFDVCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7Z0JBQ2YsQ0FBQyxDQUFDLENBQUE7WUFDTixDQUFDO1FBRUwsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0lBR0QsNEJBQVMsR0FBVCxVQUFVLEdBQWtCO1FBQ3hCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztRQUVqQixNQUFNLENBQUMsSUFBSSxPQUFPLENBQVMsVUFBQyxPQUFPLEVBQUUsTUFBTTtZQUN2QyxJQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsc0JBQXNCLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFbEQsS0FBSyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsQ0FBQztnQkFDdEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUM5QyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHO2dCQUNULE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUNmLENBQUMsQ0FBQyxDQUFBO1FBQ04sQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0lBRUQsd0NBQXFCLEdBQXJCLFVBQXNCLEtBQWM7UUFDaEMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksS0FBSyxHQUFXLEtBQUssQ0FBQyxLQUFLLENBQUM7UUFFaEMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQTtRQUd4QixJQUFJLFNBQVMsR0FBWSxFQUFFLENBQUM7UUFFNUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQztZQUM1QixDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDO2dCQUN2QixTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ3JCLENBQUMsQ0FBQyxDQUFBO1FBQ04sQ0FBQyxDQUFDLENBQUE7UUFHRixNQUFNLENBQUMsU0FBUyxDQUFBO0lBRXBCLENBQUM7SUFFRCx5Q0FBc0IsR0FBdEIsVUFBdUIsSUFBWSxFQUFFLEtBQWM7UUFDL0MsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksS0FBSyxHQUFXLElBQUksQ0FBQyxLQUFLLENBQUM7UUFFL0IsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQTtRQUV4QixJQUFJLFNBQVMsR0FBWSxFQUFFLENBQUM7UUFDNUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQztZQUM1QixDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDO2dCQUMxQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO29CQUM3QixDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDO3dCQUV2QixTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO29CQUdyQixDQUFDLENBQUMsQ0FBQTtnQkFDTixDQUFDO1lBR0wsQ0FBQyxDQUFDLENBQUE7UUFFTixDQUFDLENBQUMsQ0FBQTtRQUdGLE1BQU0sQ0FBQyxTQUFTLENBQUE7SUFFcEIsQ0FBQztJQUVMLGVBQUM7QUFBRCxDQXpXQSxBQXlXQyxJQUFBO0FBeldEOzBCQXlXQyxDQUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgXyBmcm9tIFwibG9kYXNoXCI7XG5cbmNvbnN0IGdlbyA9IHJlcXVpcmUoXCJnZW9saWJcIik7XG5cbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSBcImJsdWViaXJkXCI7XG5cblxuaW1wb3J0ICogYXMgc3VwZXJhZ2VudCBmcm9tIFwic3VwZXJhZ2VudFwiO1xuXG5cbmludGVyZmFjZSBJQm91bmRhcnkgeyAvL3dyb25nXG4gICAgbGF0aXR1ZGU6IG51bWJlcjtcbiAgICBsb25naXR1ZGU6IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIElHZW9jb2RlcyB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIHByb3ZpbmNlczogSUdlb1tdO1xuICAgIGNpdGllczogSUNpdHlbXTtcbn1cblxuXG5cbmludGVyZmFjZSBJQ2l0eSB7XG4gICAgbmF0aXZlTmFtZTogc3RyaW5nO1xuICAgIGxhdGl0dWRlOiBudW1iZXI7XG4gICAgbG9uZ2l0dWRlOiBudW1iZXI7XG4gICAgemlwY29kZTogbnVtYmVyO1xuICAgIGNpdHlDb2RlOiBzdHJpbmc7XG4gICAgc3RhdGU6IHN0cmluZztcbiAgICBjb3VudHJ5OiBzdHJpbmc7XG4gICAgaXNvTGFuZzogc3RyaW5nO1xuICAgIHR6OiBzdHJpbmc7XG4gICAgY3VycmVuY3k6IHN0cmluZztcbiAgICBjdXJyZW5jeVN5bWJvbDogc3RyaW5nO1xuICAgIGRpc3RhbmNlPzogbnVtYmVyO1xuICAgIHN1YmNvbnRpbmVudDogc3RyaW5nO1xuICAgIGNvbnRpbmVudDogc3RyaW5nO1xuICAgIHJlZ2lvbjogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSUdlbyB7XG4gICAgbmF0aXZlTmFtZTogc3RyaW5nO1xuICAgIHppcGNvZGU6IHN0cmluZztcbiAgICBjaXRpZXM6IElDaXR5W107XG4gICAgbWFpbjogSUNpdHk7XG4gICAgbGF0aXR1ZGU6IG51bWJlcjtcbiAgICBsb25naXR1ZGU6IG51bWJlcjtcbn1cblxuXG5pbnRlcmZhY2UgSXN0YXRlIHtcbiAgICByZWdpb25zOiBJR2VvY29kZXNbXTtcbiAgICBib3VuZGFyaWVzOiBJQm91bmRhcnlbXTtcbiAgICBjYXBpdGFsOiBJQ2l0eTtcbiAgICBuYXRpdmVOYW1lOiBzdHJpbmc7XG4gICAgbGF0bG5nOiBudW1iZXJbXTtcbiAgICBpc29MYW5nOiBzdHJpbmdbXTtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgdHo6IHN0cmluZztcbiAgICBjb3VudHJ5OiBzdHJpbmc7XG4gICAgc3ViY29udGluZW50OiBzdHJpbmc7XG4gICAgY29udGluZW50OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJQ291bnRyeSB7XG4gICAgc3RhdGVzOiBJc3RhdGVbXTtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgYm91bmRhcmllczogSUJvdW5kYXJ5W11bXTtcbiAgICBuYXRpdmVOYW1lOiBzdHJpbmc7XG4gICAgY2FwaXRhbDogSUNpdHk7XG4gICAgY3VycmVuY2llczogc3RyaW5nW107XG4gICAgaXNvTGFuZzogc3RyaW5nW107XG4gICAgbGF0bG5nOiBudW1iZXJbXTtcbiAgICB0ejogc3RyaW5nO1xuICAgIHN1YmNvbnRpbmVudDogc3RyaW5nO1xuICAgIGNvbnRpbmVudDogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSVN1YmNvbnRpbmVudCB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGNvdW50cmllczogSUNvdW50cnlbXTtcbiAgICBib3VuZGFyaWVzOiBJQm91bmRhcnlbXTtcbiAgICBjb250aW5lbnQ6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIElHZW9idWlsZCB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIHN1YmNvbnRpbmVudHM6IElTdWJjb250aW5lbnRbXTtcbiAgICBib3VuZGFyaWVzOiBJQm91bmRhcnlbXTtcbn1cblxuXG5pbnRlcmZhY2UgSUxvY2FsaXphdGlvbiB7XG4gICAgbGF0aXR1ZGU6IG51bWJlcjtcbiAgICBsb25naXR1ZGU6IG51bWJlcjtcbn1cblxuY29uc3QgdzogSUdlb2J1aWxkW10gPSByZXF1aXJlKFwiLi9vbmx5d29ybGQuanNvblwiKTtcblxuXG5mdW5jdGlvbiBsb2FkYkJpZ1dvcmxkZnJvbXJlbW90ZWRiKHVybCk6IFByb21pc2U8SUdlb2J1aWxkW10+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8SUdlb2J1aWxkW10+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICBsZXQgYmlnV29ybGQ6IElHZW9idWlsZFtdO1xuXG4gICAgICAgIHN1cGVyYWdlbnQuZ2V0KHVybCkuZW5kKGZ1bmN0aW9uIChlcnIsIHJlcykge1xuICAgICAgICAgICAgaWYgKGVyciB8fCAhcmVzLm9rKSB7XG5cbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGJpZ1dvcmxkID0gcmVzLmJvZHkuY29udGluZW50cztcbiAgICAgICAgICAgICAgICByZXNvbHZlKGJpZ1dvcmxkKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH0pXG5cbn1cblxuZnVuY3Rpb24gbG9hZGNvbnRyeXJlbW90ZWx5KHVybDogc3RyaW5nLCBjb3VudHJ5TmFtZTogc3RyaW5nKTogUHJvbWlzZTxJQ291bnRyeT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxJQ291bnRyeT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXG4gICAgICAgIGxldCBjb3VudHJ5OiBJQ291bnRyeTtcblxuICAgICAgICBzdXBlcmFnZW50LmdldCh1cmwgKyBcIi9jb3VudHJ5L1wiICsgY291bnRyeU5hbWUpLmVuZChmdW5jdGlvbiAoZXJyLCByZXMpIHtcbiAgICAgICAgICAgIGlmIChlcnIgfHwgIXJlcy5vaykge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvdW50cnkgPSByZXMuYm9keTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKGNvdW50cnkpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfSlcbn1cblxuXG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTG9jYWxpemUge1xuICAgIGJpZ1dvcmxkOiBJR2VvYnVpbGRbXTtcbiAgICBzdGF0ZTogSXN0YXRlO1xuICAgIHdvcmxkOiBJR2VvYnVpbGRbXTtcbiAgICByZW1vdGU6IHN0cmluZztcbiAgICB3b3JsZERCOiBzdHJpbmc7XG4gICAgbG9jYWxpemF0aW9uOiBJTG9jYWxpemF0aW9uO1xuXG4gICAgY29uc3RydWN0b3IobzogeyB3b3JsZD86IElHZW9idWlsZFtdLCBiaWdXb3JsZD86IElHZW9idWlsZFtdLCByZW1vdGU/OiBzdHJpbmcsIHdvcmxkREI/OiBzdHJpbmcsIHN0YXRlPzogSXN0YXRlIH0pIHtcbiAgICAgICAgaWYgKCFvKSB0aHJvdyBFcnJvcihcIm5vIGNvbmZcIik7XG5cblxuICAgICAgICBpZiAoby5iaWdXb3JsZCkge1xuICAgICAgICAgICAgdGhpcy5iaWdXb3JsZCA9IG8uYmlnV29ybGQ7XG4gICAgICAgICAgICB0aGlzLndvcmxkID0gdztcblxuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICBpZiAoby5zdGF0ZSkgdGhpcy5zdGF0ZSA9IG8uc3RhdGU7XG5cbiAgICAgICAgICAgIGlmIChvICYmIG8ud29ybGQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLndvcmxkID0gby53b3JsZFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLndvcmxkID0gd1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAobyAmJiBvLnJlbW90ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVtb3RlID0gby5yZW1vdGVcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobyAmJiBvLndvcmxkREIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLndvcmxkREIgPSBvLndvcmxkREJcbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIGdldENvdW50cnlGcm9tUG9zaXRpb24obzogSUxvY2FsaXphdGlvbik6IElDb3VudHJ5IHtcblxuICAgICAgICBsZXQgcG9zOiBJTG9jYWxpemF0aW9uID0geyBsYXRpdHVkZTogby5sYXRpdHVkZSwgbG9uZ2l0dWRlOiBvLmxvbmdpdHVkZSB9O1xuXG4gICAgICAgIGxldCBfdGhpcyA9IHRoaXM7XG4gICAgICAgIGxldCBleGlzdHMgPSBmYWxzZTtcbiAgICAgICAgbGV0IGM6IElDb3VudHJ5O1xuICAgICAgICBsZXQgY2VudGVycyA9IFtdO1xuXG4gICAgICAgIF8ubWFwKF90aGlzLndvcmxkLCBmdW5jdGlvbiAoY29udGluZW50KSB7XG4gICAgICAgICAgICBfLm1hcChjb250aW5lbnQuc3ViY29udGluZW50cywgZnVuY3Rpb24gKHN1YmNvbnRpbmVudCkge1xuXG4gICAgICAgICAgICAgICAgXy5tYXAoc3ViY29udGluZW50LmNvdW50cmllcywgZnVuY3Rpb24gKGNvdW50cnkpIHtcblxuICAgICAgICAgICAgICAgICAgICBfLm1hcChjb3VudHJ5LmJvdW5kYXJpZXMsIGZ1bmN0aW9uIChhcmVhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWMpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYXJlYVswXVswXSAhPT0gXCJvYmplY3RcIikge1xuXG5cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ2VvLmlzUG9pbnRJbnNpZGUocG9zLCBhcmVhKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGMgPSBjb3VudHJ5O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZW50ZXJzLnB1c2goeyBuYXRpb246IGNvdW50cnkubmFtZSwgZGlzdGFuY2U6IGdlby5nZXREaXN0YW5jZShnZW8uZ2V0Q2VudGVyT2ZCb3VuZHMoYXJlYSksIHBvcykgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5tYXAoYXJlYSwgZnVuY3Rpb24gKGEpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdlby5pc1BvaW50SW5zaWRlKHBvcywgYSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdHMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGMgPSBjb3VudHJ5O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNlbnRlcnMucHVzaCh7IG5hdGlvbjogY291bnRyeS5uYW1lLCBkaXN0YW5jZTogZ2VvLmdldERpc3RhbmNlKGdlby5nZXRDZW50ZXJPZkJvdW5kcyhhKSwgcG9zKSB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KVxuXG5cbiAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIH0pXG5cbiAgICAgICAgaWYgKCFleGlzdHMpIHtcbiAgICAgICAgICAgIGxldCBkaXN0OiBhbnkgPSBmYWxzZTtcbiAgICAgICAgICAgIF8ubWFwKGNlbnRlcnMsIGZ1bmN0aW9uIChjbykge1xuICAgICAgICAgICAgICAgIGlmICghZGlzdCB8fCBjby5kaXN0YW5jZSA8IGRpc3QuZGlzdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgZGlzdCA9IGNvXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBfLm1hcChfdGhpcy53b3JsZCwgZnVuY3Rpb24gKGNvbnRpbmVudCkge1xuICAgICAgICAgICAgICAgIF8ubWFwKGNvbnRpbmVudC5zdWJjb250aW5lbnRzLCBmdW5jdGlvbiAoc3ViY29udGluZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIF8ubWFwKHN1YmNvbnRpbmVudC5jb3VudHJpZXMsIGZ1bmN0aW9uIChjb3VudHJ5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdC5uYXRpb24gPT0gY291bnRyeS5uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYyA9IGNvdW50cnlcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcblxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjXG4gICAgfVxuXG5cbiAgICBjaGVja2lmSW5zaWRlU3RhdGUocG9zOiBJTG9jYWxpemF0aW9uKTogSUNpdHlbXSB8IGJvb2xlYW4ge1xuICAgICAgICBsZXQgX3RoaXMgPSB0aGlzO1xuICAgICAgICBpZiAoIXRoaXMuc3RhdGUpIHRocm93IEVycm9yKFwibm8gc3RhdGUgc2V0XCIpO1xuXG4gICAgICAgIGxldCBwb3NpdGlvbiA9IHRoaXMuZ2V0UG9zaXRpb25Gcm9tU3RhdGUocG9zLCBfdGhpcy5zdGF0ZSk7XG5cbiAgICAgICAgaWYgKHBvc2l0aW9uWzBdLmRpc3RhbmNlIDwgMjAwMDApIHtcbiAgICAgICAgICAgIHJldHVybiBwb3NpdGlvblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIHJlbG9hZEN1cnJlbnRTdGF0ZShwb3M6IElMb2NhbGl6YXRpb24pIHsgLy90b2RvXG4gICAgICAgIGxldCBfdGhpcyA9IHRoaXM7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJQ2l0eVtdPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgIF90aGlzLmdldFN0YXRlcyhwb3MpLnRoZW4oKHMpID0+IHtcbiAgICAgICAgICAgICAgICBfdGhpcy5sb2NhbGl6YXRpb24gPSBwb3M7XG4gICAgICAgICAgICAgICAgX3RoaXMuc3RhdGUgPSBzO1xuICAgICAgICAgICAgICAgIHJlc29sdmUoX3RoaXMuZ2V0UG9zaXRpb25Gcm9tU3RhdGUocG9zKSk7XG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9KVxuXG5cblxuICAgICAgICB9KVxuICAgIH1cblxuICAgIHNldFBvc2l0aW9uKHBvczogSUxvY2FsaXphdGlvbik6IFByb21pc2U8SUNpdHlbXT4ge1xuICAgICAgICBsZXQgX3RoaXMgPSB0aGlzO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8SUNpdHlbXT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgaWYgKCEocG9zICYmIHBvcy5sYXRpdHVkZSAmJiBwb3MubG9uZ2l0dWRlKSkge1xuICAgICAgICAgICAgICAgIHJlamVjdChcIk5vIGNvb3JkcyBwcm92aWRlZFwiKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICBpZiAoX3RoaXMuc3RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hlY2tpZkluc2lkZVN0YXRlID0gX3RoaXMuY2hlY2tpZkluc2lkZVN0YXRlKHBvcylcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoZWNraWZJbnNpZGVTdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMubG9jYWxpemF0aW9uID0gcG9zO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSg8SUNpdHlbXT5jaGVja2lmSW5zaWRlU3RhdGUpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVsb2FkQ3VycmVudFN0YXRlKHBvcykudGhlbigocykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVsb2FkQ3VycmVudFN0YXRlKHBvcykudGhlbigocykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShzKTtcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH1cblxuXG5cbiAgICBnZXRQb3NpdGlvbkZyb21TdGF0ZShwb3M6IElMb2NhbGl6YXRpb24sIFN0YXRlPzogSXN0YXRlKTogSUNpdHlbXSB7XG4gICAgICAgIGxldCBfdGhpcyA9IHRoaXM7XG5cbiAgICAgICAgLy8gbGl2ZWxsbyBuYXppb25hbGVcbiAgICAgICAgbGV0IGFsbHByb3ZpbmNlczogSUNpdHlbXSA9IF90aGlzLmdldFByb3ZpbmNlc0Zyb21TdGF0ZShTdGF0ZSk7XG5cbiAgICAgICAgXy5tYXAoYWxscHJvdmluY2VzLCBmdW5jdGlvbiAoYykge1xuICAgICAgICAgICAgYy5kaXN0YW5jZSA9IGdlby5nZXREaXN0YW5jZSh7IGxhdGl0dWRlOiBjLmxhdGl0dWRlLCBsb25naXR1ZGU6IGMubG9uZ2l0dWRlIH0sIHBvcyk7XG4gICAgICAgIH0pXG5cblxuICAgICAgICBsZXQgcmVwcm92ID0gXy50YWtlKF8ub3JkZXJCeShhbGxwcm92aW5jZXMsIFsnZGlzdGFuY2UnXSwgWydhc2MnXSksIDIpO1xuXG4gICAgICAgIGxldCBwcm92aW5jZXMgPSBbXTtcbiAgICAgICAgXy5tYXAocmVwcm92LCBmdW5jdGlvbiAoYzogSUNpdHkpIHtcblxuICAgICAgICAgICAgXy5tYXAoX3RoaXMuZ2V0Q2l0aWVzRnJvbVByb3ZpbmNlcyhjLm5hdGl2ZU5hbWUsIFN0YXRlKSwgZnVuY3Rpb24gKHApIHtcbiAgICAgICAgICAgICAgICBwLmRpc3RhbmNlID0gZ2VvLmdldERpc3RhbmNlKHsgbGF0aXR1ZGU6IHAubGF0aXR1ZGUsIGxvbmdpdHVkZTogcC5sb25naXR1ZGUgfSwgcG9zKTtcbiAgICAgICAgICAgICAgICBwcm92aW5jZXMucHVzaChwKVxuICAgICAgICAgICAgfSlcblxuICAgICAgICB9KVxuXG5cbiAgICAgICAgbGV0IGNpdGllczogSUNpdHlbXSA9IDxJQ2l0eVtdPl8udGFrZShfLm9yZGVyQnkocHJvdmluY2VzLCBbJ2Rpc3RhbmNlJ10sIFsnYXNjJ10pLCAxMCk7XG5cblxuICAgICAgICByZXR1cm4gY2l0aWVzXG5cbiAgICB9XG5cblxuICAgIGdldExvY2F0aW9uKG86IHsgY2l0eTogc3RyaW5nLCBzdGF0ZT86IHN0cmluZyB9KSB7XG4gICAgICAgIHJldHVybiB0cnVlXG5cbiAgICB9XG5cbiAgICBnZXRpbmZvKG86IHsgY2l0eTogc3RyaW5nLCBzdGF0ZT86IHN0cmluZyB9KSB7XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuXG5cbiAgICBnZXRTdGF0ZUZyb21Db3VudHJ5KHBvczogSUxvY2FsaXphdGlvbiwgY291bnRyeTogSUNvdW50cnkpOiBJc3RhdGUge1xuXG4gICAgICAgIGxldCBzdGF0ZTogSXN0YXRlO1xuXG5cbiAgICAgICAgaWYgKGNvdW50cnkuc3RhdGVzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgc3RhdGUgPSBjb3VudHJ5LnN0YXRlc1swXVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJ0b2RvXCIpXG5cbiAgICAgICAgfVxuXG5cbiAgICAgICAgcmV0dXJuIHN0YXRlXG4gICAgfVxuXG5cbiAgICBnZXRGdWxsQ291bnRyeShjb3VudHJ5TmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGxldCBfdGhpcyA9IHRoaXM7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPElDb3VudHJ5PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgIGxldCBleGlzdHM6IGFueSA9IGZhbHNlO1xuXG5cbiAgICAgICAgICAgIGlmIChfdGhpcy5iaWdXb3JsZCkge1xuICAgICAgICAgICAgICAgIF8ubWFwKF90aGlzLmJpZ1dvcmxkLCBmdW5jdGlvbiAoY29udGluZW50KSB7XG5cbiAgICAgICAgICAgICAgICAgICAgXy5tYXAoY29udGluZW50LnN1YmNvbnRpbmVudHMsIGZ1bmN0aW9uIChzdWJjb250aW5lbnQpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgXy5tYXAoc3ViY29udGluZW50LmNvdW50cmllcywgZnVuY3Rpb24gKGMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYy5uYW1lID09PSBjb3VudHJ5TmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdHMgPSBjO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICBpZiAoIWV4aXN0cykge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoXCJubyBjb3VudHJ5XCIpXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShleGlzdHMpXG5cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKF90aGlzLnJlbW90ZSkge1xuXG4gICAgICAgICAgICAgICAgbG9hZGNvbnRyeXJlbW90ZWx5KF90aGlzLnJlbW90ZSwgY291bnRyeU5hbWUpLnRoZW4oKGNvKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoY28pXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoX3RoaXMud29ybGREQikge1xuICAgICAgICAgICAgICAgIGxvYWRiQmlnV29ybGRmcm9tcmVtb3RlZGIoX3RoaXMud29ybGREQikudGhlbigod29ybGQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgXy5tYXAod29ybGQsIGZ1bmN0aW9uIChjb250aW5lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF8ubWFwKGNvbnRpbmVudC5zdWJjb250aW5lbnRzLCBmdW5jdGlvbiAoc3ViY29udGluZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5tYXAoc3ViY29udGluZW50LmNvdW50cmllcywgZnVuY3Rpb24gKGMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMubmFtZSA9PT0gY291bnRyeU5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0cyA9IGM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFleGlzdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChcIm5vIGNvdW50cnlcIilcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZXhpc3RzKVxuXG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pXG4gICAgfVxuXG5cbiAgICBnZXRTdGF0ZXMocG9zOiBJTG9jYWxpemF0aW9uKTogUHJvbWlzZTxJc3RhdGU+IHtcbiAgICAgICAgbGV0IF90aGlzID0gdGhpcztcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8SXN0YXRlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb3VudHJ5ID0gX3RoaXMuZ2V0Q291bnRyeUZyb21Qb3NpdGlvbihwb3MpO1xuXG4gICAgICAgICAgICBfdGhpcy5nZXRGdWxsQ291bnRyeShjb3VudHJ5Lm5hbWUpLnRoZW4oKGMpID0+IHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKF90aGlzLmdldFN0YXRlRnJvbUNvdW50cnkocG9zLCBjKSlcbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBnZXRQcm92aW5jZXNGcm9tU3RhdGUoc3RhdGU/OiBJc3RhdGUpOiBJQ2l0eVtdIHtcbiAgICAgICAgbGV0IF90aGlzID0gdGhpcztcbiAgICAgICAgbGV0IFN0YXRlOiBJc3RhdGUgPSBfdGhpcy5zdGF0ZTtcblxuICAgICAgICBpZiAoc3RhdGUpIFN0YXRlID0gc3RhdGVcblxuXG4gICAgICAgIGxldCBwcm92aW5jZXM6IElDaXR5W10gPSBbXTtcblxuICAgICAgICBfLm1hcChTdGF0ZS5yZWdpb25zLCBmdW5jdGlvbiAocikge1xuICAgICAgICAgICAgXy5tYXAoci5jaXRpZXMsIGZ1bmN0aW9uIChjKSB7XG4gICAgICAgICAgICAgICAgcHJvdmluY2VzLnB1c2goYylcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG5cblxuICAgICAgICByZXR1cm4gcHJvdmluY2VzXG5cbiAgICB9XG5cbiAgICBnZXRDaXRpZXNGcm9tUHJvdmluY2VzKGNpdHk6IHN0cmluZywgc3RhdGU/OiBJc3RhdGUpOiBJQ2l0eVtdIHtcbiAgICAgICAgbGV0IF90aGlzID0gdGhpcztcbiAgICAgICAgbGV0IFN0YXRlOiBJc3RhdGUgPSB0aGlzLnN0YXRlO1xuXG4gICAgICAgIGlmIChzdGF0ZSkgU3RhdGUgPSBzdGF0ZVxuXG4gICAgICAgIGxldCBwcm92aW5jZXM6IElDaXR5W10gPSBbXTtcbiAgICAgICAgXy5tYXAoU3RhdGUucmVnaW9ucywgZnVuY3Rpb24gKHIpIHtcbiAgICAgICAgICAgIF8ubWFwKHIucHJvdmluY2VzLCBmdW5jdGlvbiAocCkge1xuICAgICAgICAgICAgICAgIGlmIChwLm1haW4ubmF0aXZlTmFtZSA9PT0gY2l0eSkge1xuICAgICAgICAgICAgICAgICAgICBfLm1hcChwLmNpdGllcywgZnVuY3Rpb24gKGMpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmluY2VzLnB1c2goYylcblxuXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgfSlcblxuXG4gICAgICAgIHJldHVybiBwcm92aW5jZXNcblxuICAgIH1cblxufSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
